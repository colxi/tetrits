var D=Object.defineProperty;var P=(s,t,e)=>t in s?D(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var n=(s,t,e)=>(P(s,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const c of i)if(c.type==="childList")for(const u of c.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&r(u)}).observe(document,{childList:!0,subtree:!0});function e(i){const c={};return i.integrity&&(c.integrity=i.integrity),i.referrerPolicy&&(c.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?c.credentials="include":i.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function r(i){if(i.ep)return;i.ep=!0;const c=e(i);fetch(i.href,c)}})();class l{}n(l,"infoBox",document.getElementById("infoBox")),n(l,"boardCanvas",document.getElementById("boardCanvas")),n(l,"UICanvas",document.getElementById("UICanvas")),n(l,"buttonLeft",document.getElementById("buttonLeft")),n(l,"buttonRight",document.getElementById("buttonRight")),n(l,"buttonRotate",document.getElementById("buttonRotate")),n(l,"buttonDown",document.getElementById("buttonDown")),n(l,"mobileControls",document.getElementById("mobileControls"));class w{constructor(){n(this,"isPressed",!1);n(this,"onCurrentFrame",!1)}get isPressedOnCurrentFrame(){return this.isPressed&&this.onCurrentFrame}}class h{static init(){this.isInitiated||(document.addEventListener("keydown",this.handleKeyDown.bind(this)),document.addEventListener("keyup",this.handleKeyUp.bind(this)),document.addEventListener("contextmenu",t=>t.preventDefault()),l.buttonLeft.addEventListener("touchstart",()=>this.handleTapStart("ArrowLeft")),l.buttonRight.addEventListener("touchstart",()=>this.handleTapStart("ArrowRight")),l.buttonDown.addEventListener("touchstart",()=>this.handleTapStart("ArrowDown")),l.buttonRotate.addEventListener("touchstart",()=>this.handleTapStart("ArrowUp")),l.buttonLeft.addEventListener("touchend",()=>this.handleTapEnd("ArrowLeft")),l.buttonRight.addEventListener("touchend",()=>this.handleTapEnd("ArrowRight")),l.buttonDown.addEventListener("touchend",()=>this.handleTapEnd("ArrowDown")),l.buttonRotate.addEventListener("touchend",()=>this.handleTapEnd("ArrowUp")),this.isInitiated=!0)}static resetTapStart(){this.tapStart=Date.now()}static handleTapStart(t){this.tapStart=Date.now();const e=new KeyboardEvent("keydown",{key:t});this.handleKeyDown(e)}static handleTapEnd(t){this.tapStart=0;const e=new KeyboardEvent("keyup",{key:t});this.handleKeyUp(e)}static handleKeyDown(t){switch(t.key){case"ArrowLeft":{t.preventDefault(),this.left.isPressed=!0,this.left.onCurrentFrame=!0;break}case"ArrowRight":{t.preventDefault(),this.right.isPressed=!0,this.right.onCurrentFrame=!0;break}case"ArrowDown":{t.preventDefault(),this.down.isPressed=!0,this.down.onCurrentFrame=!0;break}case"ArrowUp":case"Shift":{t.preventDefault(),this.rotate.isPressed=!0,this.rotate.onCurrentFrame=!0;break}case"Enter":{t.preventDefault(),this.enter.isPressed=!0,this.enter.onCurrentFrame=!0;break}case"P":case"p":{t.preventDefault(),this.pause.isPressed=!0,this.pause.onCurrentFrame=!0;break}}}static handleKeyUp(t){switch(t.key){case"ArrowLeft":{t.preventDefault(),this.left.isPressed=!1,this.left.onCurrentFrame=!0;break}case"ArrowRight":{t.preventDefault(),this.right.isPressed=!1,this.right.onCurrentFrame=!0;break}case"ArrowDown":{t.preventDefault(),this.down.isPressed=!1,this.down.onCurrentFrame=!0;break}case"ArrowUp":case"Shift":{t.preventDefault(),this.rotate.isPressed=!1,this.rotate.onCurrentFrame=!0;break}case"Enter":{t.preventDefault(),this.enter.isPressed=!1,this.enter.onCurrentFrame=!0;break}case"P":case"p":{t.preventDefault(),this.pause.isPressed=!1,this.pause.onCurrentFrame=!0;break}}}static update(){this.down.onCurrentFrame=!1,this.left.onCurrentFrame=!1,this.right.onCurrentFrame=!1,this.rotate.onCurrentFrame=!1,this.pause.onCurrentFrame=!1,this.enter.onCurrentFrame=!1}}n(h,"isInitiated",!1),n(h,"enter",new w),n(h,"down",new w),n(h,"left",new w),n(h,"right",new w),n(h,"rotate",new w),n(h,"pause",new w),n(h,"tapStart",0);function R(s){return JSON.parse(JSON.stringify(s))}function F(s,t){return Math.floor(Math.random()*(t-s+1)+s)}function y(s,t){const e=[];for(let r=0;r<t;r++){const i=Array(s).fill(0);e.push(i)}return e}var g=(s=>(s.T="T",s.S="S",s.L="L",s.S_INVERTED="T_INVERTED",s.L_INVERTED="L_INVERTED",s.SQUARE="SQUARE",s.LINE="LINE",s))(g||{});class T{constructor(t){n(this,"x",4);n(this,"y",0);n(this,"matrix",y(4,3));n(this,"id");this.matrix=R(t.matrix),this.id=t.id}get width(){return this.matrix[0].length}get height(){return this.matrix.length}getBlockData(t,e){return this.matrix[e][t]}getPivotCoords(t=this.matrix){for(let e=0;e<t.length;e++)for(let r=0;r<t[e].length;r++)if(t[e][r]===2)return{x:r,y:e};throw new Error("Pivot not found")}rotate(t){if(this.id===g.SQUARE)return;const e={x:this.x,y:this.y},r=this.matrix,i=r[0].map((b,p)=>r.map(k=>k[p]).reverse()),c=this.getPivotCoords(r),u=this.getPivotCoords(i);this.x+=c.x-u.x,this.y+=c.y-u.y,this.matrix=i;for(let b=0;b<i.length;b++)if(!(b+this.y<0)){for(let p=0;p<i[b].length;p++)if(i[b][p]&&(this.x+p<0||this.x+p>=t.width||this.y+b>=t.height||t.getBlockData(p+this.x,b+this.y))){this.matrix=r,this.x=e.x,this.y=e.y;return}}}clone(){const t=new T({matrix:this.matrix,id:this.id});return t.x=this.x,t.y=this.y,t}}const E=[{id:g.L,matrix:[[0,0,1],[1,2,1]]},{id:g.L_INVERTED,matrix:[[1,0,0],[1,2,1]]},{id:g.SQUARE,matrix:[[1,1],[2,1]]},{id:g.T,matrix:[[1,2,1],[0,1,0]]},{id:g.S,matrix:[[0,1,1],[1,2,0]]},{id:g.S_INVERTED,matrix:[[1,1,0],[0,2,1]]},{id:g.LINE,matrix:[[1,1,2,1]]}],o={speedMultiplier:10,grid:{width:10,height:20},block:{size:20}},f=class f{static get width(){return this.boardData[0].length}static get height(){return this.boardData.length}static init(){this.canvas.width=o.block.size*o.grid.width,this.canvas.height=o.block.size*o.grid.height,this.context.imageSmoothingEnabled=!1}static render(){this.context.lineWidth=2,this.context.fillStyle="#fcbe24",this.context.strokeStyle="#fcbe24",this.context.clearRect(0,0,this.canvas.width,this.canvas.height);for(let r=0;r<o.grid.height;r++)for(let i=0;i<o.grid.width;i++){const c=i*o.block.size,u=r*o.block.size;f.boardData[r][i]?this.context.fillRect(c,u,o.block.size,o.block.size):this.context.strokeRect(c,u,o.block.size,o.block.size)}const t=f.currentTetromino.getPivotCoords();for(let r=0;r<f.currentTetromino.height;r++)for(let i=0;i<f.currentTetromino.width;i++){if(!f.currentTetromino.getBlockData(i,r))continue;const c=(i+f.currentTetromino.x)*o.block.size,u=(r+f.currentTetromino.y)*o.block.size;this.context.fillStyle=t.x===i&&t.y===r?"#faaa20":"#fcbe24",this.context.fillRect(c,u,o.block.size,o.block.size)}const e=this.currentTetromino.clone();for(;;)if(e.y++,f.hasCollision(e)){e.y--;break}for(let r=0;r<e.height;r++)for(let i=0;i<e.width;i++){if(!e.getBlockData(i,r))continue;const c=(i+e.x)*o.block.size,u=(r+e.y)*o.block.size;this.context.fillStyle="#fcbe2488",this.context.fillRect(c,u,o.block.size,o.block.size)}if(h.down.isPressed){const r=Date.now()-h.tapStart;if(r>100){let i=(r-100)/3;i>100&&(i=100),this.context.beginPath(),this.context.fillStyle="#fcbe2466",this.context.ellipse(100,400,i,i/2,Math.PI,0,Math.PI),this.context.fill()}}}static reset(){this.boardData=y(o.grid.width,o.grid.height),this.createNewTetromino()}static hasBlocksInFirstRow(){return this.boardData[0].some(Boolean)}static getRandomTetromino(){const t=F(0,E.length-1);return new T(E[t])}static createNewTetromino(){this.currentTetromino=this.nextTetromino,this.nextTetromino=this.getRandomTetromino()}static getBlockData(t,e){return this.boardData[e][t]}static hasCollision(t=this.currentTetromino){if(t.y+t.height>this.height||t.x<0||t.x+t.width>this.width)return!0;for(let e=0;e<t.height;e++)if(!(e+this.currentTetromino.y<0))for(let r=0;r<t.width;r++){const i=t.x+r,c=t.y+e,u=this.getBlockData(i,c);if(t.getBlockData(r,e)&&u)return!0}return!1}static fixCurrentTetrominoToBoard(){for(let t=0;t<this.currentTetromino.height;t++)for(let e=0;e<this.currentTetromino.width;e++)if(this.currentTetromino.getBlockData(e,t)){const r=this.currentTetromino.x+e,i=this.currentTetromino.y+t;this.boardData[i][r]=1}}static processCompletedRows(){let t=0;for(let e=0;e<this.boardData.length;e++)!this.boardData[e].some(c=>c===0)&&(t++,this.boardData.splice(e,1),this.boardData.unshift([0,0,0,0,0,0,0,0,0,0]));return t}};n(f,"context",l.boardCanvas.getContext("2d")),n(f,"canvas",l.boardCanvas),n(f,"currentTetromino",f.getRandomTetromino()),n(f,"nextTetromino",f.getRandomTetromino()),n(f,"boardData",y(o.grid.width,o.grid.height));let a=f;class x{static init(){this.canvas.width=o.block.size*6,this.canvas.height=o.block.size*4,this.context.imageSmoothingEnabled=!1,this.context.strokeStyle="#fcbe24",this.context.fillStyle="#fcbe24",this.context.lineWidth=2,d.isMobile&&(this.showMobileControls(),this.mobileControls.addEventListener("click",this.hideMobileControls.bind(this)))}static hideMobileControls(){document.body.removeAttribute("preview-controls")}static showMobileControls(){document.body.setAttribute("preview-controls","true")}static render(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.strokeRect(0,0,this.canvas.width,this.canvas.height);const t=20,e=20;for(let r=0;r<a.nextTetromino.height;r++)for(let i=0;i<a.nextTetromino.width;i++){if(!a.nextTetromino.matrix[r][i])continue;const c=i*o.block.size+t,u=r*o.block.size+e;this.context.fillRect(c,u,o.block.size,o.block.size)}l.infoBox.innerHTML=`
     ${d.isPaused?"PAUSED<br/><br/>":""}
     Level: ${d.level}<br/>
     Points: ${d.score}<br/><br/>
     ARROW = Move<br/>
     SHIFT = Rotate<br/>
     ENTER = Fall<br/>
     P = Pause<br/>
   `}}n(x,"context",l.UICanvas.getContext("2d")),n(x,"mobileControls",l.mobileControls),n(x,"canvas",l.UICanvas);const m=class m{static get level(){return Math.floor(this.speed/5)}static get isMobile(){return window.innerWidth<800}static pause(){this.isPaused=!0}static resume(){this.isPaused=!1}static start(){x.init(),h.init(),a.init(),this.loop(0)}static loop(t){this.update(t),this.render(t),h.update(),requestAnimationFrame(this.boundedLoopMethod)}static onUpdate(t){this.update=t}static onRender(t){this.render=t}};n(m,"score",0),n(m,"speed",0),n(m,"isPaused",!1),n(m,"boundedLoopMethod",m.loop.bind(m)),n(m,"update",()=>{}),n(m,"render",()=>{});let d=m,v=0;function L(s){s-v>1500-d.speed*o.speedMultiplier&&(v=s,a.currentTetromino.y++,a.hasCollision()&&(a.currentTetromino.y--,C()))}function S(s){const t=h.down.isPressed&&Date.now()-h.tapStart>500;if(h.enter.isPressedOnCurrentFrame||t){for(;;)if(a.currentTetromino.y++,a.hasCollision()){a.currentTetromino.y--,C();break}h.resetTapStart()}h.rotate.isPressedOnCurrentFrame&&a.currentTetromino.rotate(a),h.left.isPressedOnCurrentFrame&&(a.currentTetromino.x--,a.hasCollision()&&a.currentTetromino.x++),h.right.isPressedOnCurrentFrame&&(a.currentTetromino.x++,a.hasCollision()&&a.currentTetromino.x--),h.down.isPressedOnCurrentFrame&&(a.currentTetromino.y++,a.hasCollision()?(a.currentTetromino.y--,C()):v=s)}function C(){a.fixCurrentTetrominoToBoard();const s=a.processCompletedRows();s&&(d.score+=s*10,d.speed+=1),a.hasBlocksInFirstRow()&&(a.reset(),d.score=0,d.speed=0),a.createNewTetromino()}d.onUpdate(s=>{h.pause.isPressedOnCurrentFrame&&(d.isPaused?d.resume():d.pause()),!d.isPaused&&(L(s),S(s))});d.onRender(()=>{a.render(),x.render()});d.start();
